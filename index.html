<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>JamCam</title>
  <script src="build/tracking.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <section id="cover">
    <h1>Welcome to JamCam</h1>
    <button id="start">Get Started</button>
    <p>
      You'll need your webcam for this!
    </p>
  </section>
  <section id="videoWrapper">
    <div id="videoWrapWrapper">
      <video id="myVideo" preload autoplay loop muted></video>
      <div id="newColorGuide"></div>
    </div>
    <div id="presetsWrapper">
      <div id="presetCategoryWrapper">
        <div class="btnCategoryWrapper">
          <button id="category-1" value="top">Popular</button>
        </div>
        <!-- <div class="btnPresetWrapper">
          <button id="category-2" value="85">85 BPM</button>
        </div>
        <div class="btnPresetWrapper">
          <button id="category-3" value="90">90 BPM</button>
        </div> -->
        <div class="btnPresetWrapper">
          <button id="category-4" value="97">97 BPM</button>
        </div> <!--
        <div class="btnPresetWrapper">
          <button id="category-5" value="100">100 BPM</button>
        </div>
        <div class="btnPresetWrapper">
          <button id="category-6" value="110">110 BPM</button>
        </div> -->
      </div>
      <div id="presetTrackWrapper">

      </div>
    </div>
  </section>
  <section id="canvasWrapper">
    <canvas id="canvasScreenshot"></canvas>
  </section>
  <section id="currentColorWrapper">
    <div id="currentColor1" class="currentColors">
    </div>
    <div id="currentColor2" class="currentColors">
    </div>
    <div id="currentColor3" class="currentColors">
    </div>
  </section>
  <section id="controlsContainer">
    <div class="btnWrapper">
      <button id="btnNewColor">Register New Color</button>
    </div>
    <div class="btnWrapper">
      <button id="btnReset">Reset</button>
    </div>
    <div class="btnWrapper">
      <button id="btnGuides">Toggle Guides</button>
    </div>
    <div class="btnWrapper">
      <button id="btnPresets">Presets</button>
    </div>
  </section>
  <section id="audioWrapper">
    <audio id="sound1" data-number='0' type='audio/ogg' src="./sounds/top/niceforwhat/niceforwhat-hihat-2.ogg" preload='auto'></audio>
    <audio id="sound2" data-number='1' type='audio/ogg' src="./sounds/top/niceforwhat/niceforwhat-beats-2.ogg" preload='auto'></audio>
    <audio id="sound3" data-number='2' type='audio/ogg' src="./sounds/top/niceforwhat/niceforwhat-sample-2.ogg" preload='auto'></audio>
  </section>
  <script>
  // {'category': 'category-2',
  // 'bpm' : '85',
  // 'preset': [
  //   { 'id': 'preset-1', 'name': 'Sound 1', 'trackOne': './sounds/85/beats/beats-1.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-1.ogg', 'trackThree': './sounds/85/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-2', 'name': 'Sound 2', 'trackOne': './sounds/85/beats/beats-2.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-2.ogg', 'trackThree': './sounds/85/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-3', 'name': 'Sound 3', 'trackOne': './sounds/85/beats/beats-3.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-3.ogg', 'trackThree': './sounds/85/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-4', 'name': 'Sound 4', 'trackOne': './sounds/85/beats/beats-4.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-4.ogg', 'trackThree': './sounds/85/keysline/keysline-4.ogg'},
  //   { 'id': 'preset-5', 'name': 'Sound 5', 'trackOne': './sounds/85/beats/beats-5.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-5.ogg', 'trackThree': './sounds/85/keysline/keysline-5.ogg'},
  //   { 'id': 'preset-6', 'name': 'Sound 6', 'trackOne': './sounds/85/beats/beats-6.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-6.ogg', 'trackThree': './sounds/85/keysline/keysline-6.ogg'},
  //   { 'id': 'preset-7', 'name': 'Sound 7', 'trackOne': './sounds/85/beats/beats-7.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-7.ogg', 'trackThree': './sounds/85/keysline/keysline-7.ogg'},
  //   { 'id': 'preset-8', 'name': 'Sound 8', 'trackOne': './sounds/85/beats/beats-8.ogg', 'trackTwo': './sounds/85/guitarline/guitarline-8.ogg', 'trackThree': './sounds/85/keysline/keysline-8.ogg'}
  // ]},
  // {'category': 'category-3',
  // 'bpm' : '90',
  // 'preset': [
  //   { 'id': 'preset-1', 'name': 'Sound 1', 'trackOne': './sounds/90/beats/beats-1.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-1.ogg', 'trackThree': './sounds/90/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-2', 'name': 'Sound 2', 'trackOne': './sounds/90/beats/beats-2.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-2.ogg', 'trackThree': './sounds/90/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-3', 'name': 'Sound 3', 'trackOne': './sounds/90/beats/beats-3.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-3.ogg', 'trackThree': './sounds/90/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-4', 'name': 'Sound 4', 'trackOne': './sounds/90/beats/beats-4.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-4.ogg', 'trackThree': './sounds/90/keysline/keysline-4.ogg'},
  //   { 'id': 'preset-5', 'name': 'Sound 5', 'trackOne': './sounds/90/beats/beats-5.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-5.ogg', 'trackThree': './sounds/90/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-6', 'name': 'Sound 6', 'trackOne': './sounds/90/beats/beats-6.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-6.ogg', 'trackThree': './sounds/90/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-7', 'name': 'Sound 7', 'trackOne': './sounds/90/beats/beats-7.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-7.ogg', 'trackThree': './sounds/90/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-8', 'name': 'Sound 8', 'trackOne': './sounds/90/beats/beats-8.ogg', 'trackTwo': './sounds/90/guitarline/guitarline-8.ogg', 'trackThree': './sounds/90/keysline/keysline-4.ogg'}
  // ]},
  // {'category': 'category-4',
  // 'bpm' : '97',
  // 'preset': [
  //   { 'id': 'preset-1', 'name': 'Sound 1', 'trackOne': './sounds/97/beats/beats-1.ogg', 'trackTwo': './sounds/97/bassline/bassline-1.ogg', 'trackThree': './sounds/97/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-2', 'name': 'Sound 2', 'trackOne': './sounds/97/beats/beats-2.ogg', 'trackTwo': './sounds/97/bassline/bassline-2.ogg', 'trackThree': './sounds/97/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-3', 'name': 'Sound 3', 'trackOne': './sounds/97/beats/beats-3.ogg', 'trackTwo': './sounds/97/bassline/bassline-3.ogg', 'trackThree': './sounds/97/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-4', 'name': 'Sound 4', 'trackOne': './sounds/97/beats/beats-4.ogg', 'trackTwo': './sounds/97/bassline/bassline-4.ogg', 'trackThree': './sounds/97/keysline/keysline-4.ogg'},
  //   { 'id': 'preset-5', 'name': 'Sound 5', 'trackOne': './sounds/97/beats/beats-5.ogg', 'trackTwo': './sounds/97/bassline/bassline-5.ogg', 'trackThree': './sounds/97/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-6', 'name': 'Sound 6', 'trackOne': './sounds/97/beats/beats-6.ogg', 'trackTwo': './sounds/97/bassline/bassline-6.ogg', 'trackThree': './sounds/97/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-7', 'name': 'Sound 7', 'trackOne': './sounds/97/beats/beats-7.ogg', 'trackTwo': './sounds/97/bassline/bassline-7.ogg', 'trackThree': './sounds/97/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-8', 'name': 'Sound 8', 'trackOne': './sounds/97/beats/beats-8.ogg', 'trackTwo': './sounds/97/bassline/bassline-8.ogg', 'trackThree': './sounds/97/keysline/keysline-4.ogg'}
  // ]},
  // {'category': 'category-5',
  // 'bpm' : '100',
  // 'preset': [
  //   { 'id': 'preset-1', 'name': 'Sound 1', 'trackOne': './sounds/100/beats/beats-1.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-1.ogg', 'trackThree': './sounds/100/bassline/bassline-1.ogg', 'trackFour': './sounds/100/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-2', 'name': 'Sound 2', 'trackOne': './sounds/100/beats/beats-2.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-2.ogg', 'trackThree': './sounds/100/bassline/bassline-2.ogg', 'trackFour': './sounds/100/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-3', 'name': 'Sound 3', 'trackOne': './sounds/100/beats/beats-3.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-3.ogg', 'trackThree': './sounds/100/bassline/bassline-3.ogg', 'trackFour': './sounds/100/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-4', 'name': 'Sound 4', 'trackOne': './sounds/100/beats/beats-4.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-4.ogg', 'trackThree': './sounds/100/bassline/bassline-4.ogg', 'trackFour': './sounds/100/keysline/keysline-4.ogg'},
  //   { 'id': 'preset-5', 'name': 'Sound 5', 'trackOne': './sounds/100/beats/beats-5.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-5.ogg', 'trackThree': './sounds/100/bassline/bassline-5.ogg', 'trackFour': './sounds/100/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-6', 'name': 'Sound 6', 'trackOne': './sounds/100/beats/beats-6.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-6.ogg', 'trackThree': './sounds/100/bassline/bassline-6.ogg', 'trackFour': './sounds/100/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-7', 'name': 'Sound 7', 'trackOne': './sounds/100/beats/beats-7.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-7.ogg', 'trackThree': './sounds/100/bassline/bassline-7.ogg', 'trackFour': './sounds/100/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-8', 'name': 'Sound 8', 'trackOne': './sounds/100/beats/beats-8.ogg', 'trackTwo': './sounds/100/guitarline/guitarline-8.ogg', 'trackThree': './sounds/100/bassline/bassline-8.ogg', 'trackFour': './sounds/100/keysline/keysline-4.ogg'}
  // ]},
  // {'category': 'category-6',
  // 'bpm' : '110',
  // 'preset': [
  //   { 'id': 'preset-1', 'name': 'Sound 1', 'trackOne': './sounds/110/beats/beats-1.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-1.ogg', 'trackThree': './sounds/110/bassline/bassline-1.ogg', 'trackFour': './sounds/110/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-2', 'name': 'Sound 2', 'trackOne': './sounds/110/beats/beats-2.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-2.ogg', 'trackThree': './sounds/110/bassline/bassline-2.ogg', 'trackFour': './sounds/110/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-3', 'name': 'Sound 3', 'trackOne': './sounds/110/beats/beats-3.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-3.ogg', 'trackThree': './sounds/110/bassline/bassline-3.ogg', 'trackFour': './sounds/110/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-4', 'name': 'Sound 4', 'trackOne': './sounds/110/beats/beats-4.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-4.ogg', 'trackThree': './sounds/110/bassline/bassline-4.ogg', 'trackFour': './sounds/110/keysline/keysline-4.ogg'},
  //   { 'id': 'preset-5', 'name': 'Sound 5', 'trackOne': './sounds/110/beats/beats-5.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-5.ogg', 'trackThree': './sounds/110/bassline/bassline-5.ogg', 'trackFour': './sounds/110/keysline/keysline-1.ogg'},
  //   { 'id': 'preset-6', 'name': 'Sound 6', 'trackOne': './sounds/110/beats/beats-6.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-6.ogg', 'trackThree': './sounds/110/bassline/bassline-6.ogg', 'trackFour': './sounds/110/keysline/keysline-2.ogg'},
  //   { 'id': 'preset-7', 'name': 'Sound 7', 'trackOne': './sounds/110/beats/beats-7.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-7.ogg', 'trackThree': './sounds/110/bassline/bassline-7.ogg', 'trackFour': './sounds/110/keysline/keysline-3.ogg'},
  //   { 'id': 'preset-8', 'name': 'Sound 8', 'trackOne': './sounds/110/beats/beats-8.ogg', 'trackTwo': './sounds/110/guitarline/guitarline-8.ogg', 'trackThree': './sounds/110/bassline/bassline-8.ogg', 'trackFour': './sounds/110/keysline/keysline-4.ogg'}
  // ]},


    const soundPresets = [
      {'category': 'category-1',
      'bpm' : 'top',
      'preset': [
        {
          'id': 'preset-1',
          'name': 'Exchange',
          'layers':[
            {'type': 'beat',
            'path' : './sounds/top/exchange/exchange-beats.ogg'},
            {'type': 'synth',
            'path' : './sounds/top/exchange/exchange-synth-2.ogg'},
            {'type': 'sample',
            'path' : './sounds/top/exchange/exchange-sample-2.ogg'}
          ]
        },
        {
          'id': 'preset-2',
          'name': 'Nice For What',
          'layers': [
            {'type': 'hi hat',
            'path' : './sounds/top/niceforwhat/niceforwhat-hihat-2.ogg'},
            {'type': 'beat',
            'path' : './sounds/top/niceforwhat/niceforwhat-beats-2.ogg'},
            {'type': 'sample',
            'path' : './sounds/top/niceforwhat/niceforwhat-sample-2.ogg'},
          ]
        },
        {
          'id': 'preset-3',
          'name': 'No Limit',
          'layers': [
            {'type': 'synth',
            'path' : './sounds/top/nolimit/nolimit-synth.ogg'},
            {'type': 'chimes',
            'path' : './sounds/top/nolimit/nolimit-chimes.ogg'},
            {'type': 'hi hat',
            'path' : './sounds/top/nolimit/nolimit-hihat.ogg'},
            {'type': 'beats',
            'path' : './sounds/top/nolimit/nolimit-beats.ogg'},
            {'type': 'sample',
            'path' : './sounds/top/nolimit/nolimit-sample.ogg'}
          ]
        },
        {
          'id': 'preset-4',
          'name': 'Panda',
          'layers': [
            {'type': 'synth',
            'path' : './sounds/top/panda/panda-synth.ogg'},
            {'type': 'hi hat',
            'path' : './sounds/top/panda/panda-hihat.ogg'},
            {'type': 'beats',
            'path' : './sounds/top/panda/panda-beats.ogg'},
            {'type': 'melody',
            'path' : './sounds/top/panda/panda-melody.ogg'}
          ]
        },
        {
          'id': 'preset-5',
          'name': 'One Dance',
          'layers': [
            {'type': 'synth',
            'path' : './sounds/top/onedance/onedance-synth-2.ogg'},
            {'type': 'melody',
            'path' : './sounds/top/onedance/onedance-melody-2.ogg'},
            {'type': 'beats',
            'path' : './sounds/top/onedance/onedance-beats-1-2.ogg'},
            {'type': 'second beats',
            'path' : './sounds/top/onedance/onedance-beats-2-2.ogg'},
            {'type': 'sample',
            'path' : './sounds/top/onedance/onedance-sample-2.ogg'}
          ]
        },
        {
          'id': 'preset-6',
          'name': 'Work',
          'layers': [
            {'type': 'synth',
            'path' : './sounds/top/work/work-synth-2.ogg'},
            {'type': 'effects',
            'path' : './sounds/top/work/work-effects-2.ogg'},
            {'type': 'beats',
            'path' : './sounds/top/work/work-beats-2.ogg'},
            {'type': 'melody',
            'path' : './sounds/top/work/work-melody-3.ogg'},
            {'type': 'melody-2',
            'path' : './sounds/top/work/work-melody-2-2.ogg'},
            {'type': 'bridge',
            'path' : './sounds/top/work/work-bridge-2.ogg'}
          ]
        }
      ]
    },
    {'category': 'category-4',
    'bpm' : '97',
    'preset': [
      {
        'id': 'preset-1',
        'name': 'Sound 1',
        'layers':[
        {'type': 'beat',
        'path': './sounds/97/beats/beats-1.ogg'},
        {'type': 'bass line',
        'path':'./sounds/97/bassline/bassline-1.ogg'},
        {'type': 'keys',
        'path':'./sounds/97/keysline/keysline-1.ogg'}]
      },
      {
        'id': 'preset-2',
        'name': 'Sound 2',
        'layers': [
          {'type': 'beat',
          'path': './sounds/97/beats/beats-2.ogg'},
          {'type': 'bass line',
          'path':'./sounds/97/bassline/bassline-2.ogg'},
          {'type': 'keys',
          'path':'./sounds/97/keysline/keysline-2.ogg'}
        ]
      }
      // { 'id': 'preset-3', 'name': 'Sound 3', 'trackOne': './sounds/97/beats/beats-3.ogg', 'trackTwo': './sounds/97/bassline/bassline-3.ogg', 'trackThree': './sounds/97/keysline/keysline-3.ogg'},
      // { 'id': 'preset-4', 'name': 'Sound 4', 'trackOne': './sounds/97/beats/beats-4.ogg', 'trackTwo': './sounds/97/bassline/bassline-4.ogg', 'trackThree': './sounds/97/keysline/keysline-4.ogg'},
      // { 'id': 'preset-5', 'name': 'Sound 5', 'trackOne': './sounds/97/beats/beats-5.ogg', 'trackTwo': './sounds/97/bassline/bassline-5.ogg', 'trackThree': './sounds/97/keysline/keysline-1.ogg'},
      // { 'id': 'preset-6', 'name': 'Sound 6', 'trackOne': './sounds/97/beats/beats-6.ogg', 'trackTwo': './sounds/97/bassline/bassline-6.ogg', 'trackThree': './sounds/97/keysline/keysline-2.ogg'},
      // { 'id': 'preset-7', 'name': 'Sound 7', 'trackOne': './sounds/97/beats/beats-7.ogg', 'trackTwo': './sounds/97/bassline/bassline-7.ogg', 'trackThree': './sounds/97/keysline/keysline-3.ogg'},
      // { 'id': 'preset-8', 'name': 'Sound 8', 'trackOne': './sounds/97/beats/beats-8.ogg', 'trackTwo': './sounds/97/bassline/bassline-8.ogg', 'trackThree': './sounds/97/keysline/keysline-4.ogg'}
    ]}
    ];
    const click = new Audio('./sounds/click.mp3');
    click.volume = 0.5;
    const cover = document.querySelector('#cover');
    const video = document.querySelector('#myVideo');
    const audioWrapper = document.querySelector('#audioWrapper');

    const newColorGuide = document.querySelector('#newColorGuide');
    //for clickNewColor()
    const vW = video.clientWidth;
    const vH = video.clientHeight;
    const pixelRatio = Number(vW / vH);
    const canvasW = video.clientWidth - 100;
    const canvasH = Number(canvasW / pixelRatio);
    let registerComplete = false; //begins tracker when true

    const presetWrapper = document.querySelector('#presetsWrapper');

    const btnNewColor = document.querySelector('#btnNewColor');
    const btnReset = document.querySelector('#btnReset');
    const allButtons = document.querySelectorAll('button');

    const colorWrapper = document.querySelector('#currentColorWrapper');

    const canvasScreenshot = document.querySelector('#canvasScreenshot');
    const THRESHOLD = 10;

    let soundList = document.querySelectorAll('audio');
    let sounds = [...soundList];
    let soundPlaying = [];

    let colorList = document.querySelectorAll('.currentColors');
    let colorDisplay = [...colorList];
    // let colorSet = []; //colorProps.set
    // let detectColor = [], //colorProps.detected
    let colorStore = []; //colorProps.name
    let colorProps = [];

    // let audio1 = new Audio("./sounds/top/niceforwhat/niceforwhat-hihat.ogg");
    // audio1.defaultMuted = true;
    // audio1.id = 1;
    // audio1.loop = true;
    // console.log(audio1);

    sounds.forEach(sound => {
      sound.volume = 0;
      // sound.muted = true;
      soundPlaying.push(false);
      colorProps.push({'name': '', 'set': false, 'detected': false});
    });
    console.log('colorProps initiated')
    console.log(colorProps);
    function handleOnCanPlay(){
      console.log(this + 'is ready to play');
    }


    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then((stream) => {
          try{
            video.srcObject = stream;
            video.play();
          } catch (err){
            video.src = URL.createObjectURL(stream);
          }
        }).catch((err) => {console.log(err)});
    }

    let trackerTask;
    let colors = new tracking.ColorTracker();

    let startMusic = false;
    let count = 0; //delays for color detection

    //Establish structure for trackElement nodes
    let divTrackWrapper = document.createElement('div');
    divTrackWrapper.setAttribute('class', 'btnPresetWrapper');
    let btnPresetElement = document.createElement('button');
    divTrackWrapper.appendChild(btnPresetElement);

    let currentCategory, currentPreset;
    // for (let i = 0; i < colorProps.length; i++){
    //   detectColor.push(false);
    // }
    let counter = 0;
    function startTracking(){
      // let colorArray = colors.getColors();
      console.log('startTracking fired');

      colors.on('track', (event) => { //same as tracker.on
          if (event.data.length === 0) {
              // No colors were detected in this frame.
              if (sounds[0].volume > 0 ||
                  sounds[1].volume > 0||
                  sounds[2].volume > 0) muteAll();
              // if(soundPlaying[0]) mute(sounds[0]);
              // if(soundPlaying[1]) mute(sounds[1]);
              // if(soundPlaying[2]) mute(sounds[2]);
              // if(soundPlaying[3]) mute(sounds[3]);
              // if(soundPlaying[4]) mute(sounds[4]);
              // if(soundPlaying[5]) mute(sounds[5]);

          } else {
            if(!startMusic) replay(sounds);
            // console.log('eventdata');
            // console.log(event.data);
            // console.log('colorProps');
            // console.log(colorProps);
            for (let i = 0; i < colorProps.length; i++){
              // console.log('in for loop round:' + i);
              let match = event.data.find((rect) => {
                // console.log('in event.data.find:');
                // if (rect.color === colorProps[i].name){
                  return rect.color === colorProps[i].name;
                  // colorProps[i].detected = true;
                  // console.log(colorProps);
                // } else {
                //
                // }
              });
              // console.log(match);
              if (match === undefined){
                colorProps[i].detected = false;
              } else {
                colorProps[i].detected = true;
              }
            }
            // console.log('colorProps AFTER for loop');
            // console.log(colorProps);
            for (let x = 0; x < colorProps.length; x++){
              sounds[x].volume = (colorProps[x].detected ? 1 : 0);
            }
          }
          // counter++
          // console.log('Round' + counter);
      });

      trackerTask = tracking.track('#myVideo', colors);
      trackerTask.run();
    } //end of startTracking()

            // event.data.forEach((rect) => {
            //     console.log(`color: ${rect.color}`);
            //     //
            //     // // if (rect.color == 'COLOR0' || rect.color == 'COLOR1' || rect.color == 'COLOR2'){
            //     // // }
            //     //
            //     // //OPTION 1: This method will continue to play 2nd color as long as 1 color stays on screen. When no colors are found, sound is muted.
            //     // for (let i = 0; i < colorArray.length; i++){
            //     //   if (rect.color == colorArray[i]){
            //     //     detectColor[i] = true;
            //     //     break;
            //     //   }
            //     // }
            //
            //     if (rect.color == 'COLOR0'){
            //       colorProps[0].detected = true;
            //     }
            //
            //     if (rect.color == 'COLOR1'){
            //       colorProps[1].detected = true;
            //     }
            //
            //     if (rect.color == 'COLOR2'){
            //       colorProps[2].detected = true;
            //     }
            //
            //     // if (rect.color == 'COLOR3'){
            //     //   console.log('COLOR3 detected');
            //     //   if (detectColor[3] !== undefined){
            //     //     console.log('detectColor[3] undefined');
            //     //     detectColor[3] = true;
            //     //   }
            //     // }
            //     //
            //     // if (rect.color == 'COLOR4'){
            //     //   console.log('COLOR4 detected');
            //     //   if (detectColor[4] !== undefined){
            //     //     console.log('detectColor[4] undefined');
            //     //     detectColor[4] = true;
            //     //   }
            //     // }
            //     //
            //     // if (rect.color == 'COLOR5'){
            //     //   console.log('COLOR5 detected');
            //     //   if (detectColor[5] !== undefined){
            //     //     console.log('detectColor[5] undefined');
            //     //     detectColor[5] = true;
            //     //   }
            //     // }
            //
            //
            //     if (count > colorProps.length){
            //       // sounds.forEach((sound, i) => {
            //       //   sound.volume = (detectColor[i] ? 1 : 0);
            //       // });
            //
            //       sounds[0].mute = (colorProps[0].detected ? false : true);
            //       sounds[1].mute = (colorProps[1].detected ? false : true);
            //       sounds[2].mute = (colorProps[2].detected ? false : true);
            //       // if(sounds[3]){sounds[3].volume = (detectColor[3] ? 1 : 0)}
            //       // if(sounds[4]){sounds[4].volume = (detectColor[4] ? 1 : 0)}
            //       // if(sounds[5]){sounds[5].volume = (detectColor[5] ? 1 : 0)}
            //       // console.log(sounds);
            //       count = 0;
            //     }
            //     count++;
            // });
            //
            // // sounds.forEach((sound, i) => {
            // //   sound.volume = (detectColor[i] ? 1 : 0);
            // // });
            // sounds[0].mute = (colorProps[0].detected ? false : true);
            // sounds[1].mute = (colorProps[1].detected ? false : true);
            // sounds[2].mute = (colorProps[2].detected ? false : true);
            // if(sounds[3]){sounds[3].volume = (detectColor[3] ? 1 : 0)}
            // if(sounds[4]){sounds[4].volume = (detectColor[4] ? 1 : 0)}
            // if(sounds[5]){sounds[5].volume = (detectColor[5] ? 1 : 0)}



  function clickNewColor(){
    // const vW = video.clientWidth;
    // const vH = video.clientHeight;
    // const pixelRatio = Number(vW / vH);
    // const canvasW = video.clientWidth - 100;
    // const canvasH = Number(canvasW / pixelRatio);

    canvasScreenshot.width = canvasW;
    canvasScreenshot.height = canvasH;

    let ctx = canvasScreenshot.getContext('2d');
    ctx.webkitImageSmoothingEnabled = true;
    ctx.msImageSmoothingEnabled = true;
    ctx.imageSmoothingEnabled = true;

    // Draws current image from the video element into the canvas
    const sX = newColorGuide.offsetLeft-video.offsetLeft;
    const sY = newColorGuide.offsetTop-video.offsetTop;
    const sWidth = newColorGuide.offsetWidth;
    const sHeight = newColorGuide.offsetHeight;

    ctx.drawImage(video, sX, sY, sWidth, sHeight, 0, 0, sWidth, sHeight);

    const imageData = ctx.getImageData(0, 0, sWidth, sHeight);

    //Grabs all the data in scanned image
    const data = imageData.data;
    let rMin = 255, rMax = 0, gMin = 255, gMax = 0, bMin = 255, bMax = 0;

    //sorts through imageData.data array to find rgb min and max values
    for (let i = 0; i < data.length; i += 4){
      data[i]; //r
      data[i+1]; //g
      data[i+2]; //b

      if (data[i] < rMin){ rMin = data[i]; };
      if (data[i] > rMax){ rMax = data[i]; };
      if (data[i+1] < gMin){ gMin = data[i+1]; };
      if (data[i+1] > gMax){ gMax = data[i+1]; };
      if (data[i+2] < bMin){ bMin = data[i+2]; };
      if (data[i+2] > bMax){ bMax = data[i+2]; };
    }

    // displayColor(rMin, rMax, gMin, gMax, bMin, bMax);
    registerColor(rMin, rMax, gMin, gMax, bMin, bMax);
  }


  function registerColor(R_MIN, R_MAX, G_MIN, G_MAX, B_MIN, B_MAX){
    for (let i = 0; i < colorProps.length; i++){
      if (!colorProps[i].set){

        colors.constructor.registerColor(`COLOR${i}`, (r, g, b) => {
          if (r > R_MIN - THRESHOLD && r < R_MAX + THRESHOLD && g > G_MIN - THRESHOLD && g < G_MAX + THRESHOLD && b > B_MIN - THRESHOLD && b < B_MAX + THRESHOLD) {
            return true;
          }
            return false;
        });
        displayColor(R_MIN, R_MAX, G_MIN, G_MAX, B_MIN, B_MAX, i);

        colorProps[i].set = true;
        colorProps[i].name = `COLOR${i}`;
        // colorStore.push(`COLOR${i}`);
        // colors.setColors(colorStore);
        // console.log(`getColors(): ${colors.getColors()}`);
        console.log(`${i} and ${colorDisplay.length}`);
        console.log(colorProps);

        if (i == colorDisplay.length-1){
          console.log('end of registration');
          for (let x = 0; x < colorProps.length; x++){
            colorStore.push(colorProps[x].name);
          }
          colors.setColors(colorStore);
          btnNewColor.style.visibility = 'hidden';
          registerComplete = true;
         //DISPLAY COLOR NUMBER
        }
        break;
      }
    }

    if (registerComplete){
      startTracking();
    }
  }

    // if (!colorSet[0]){
    //   colors.constructor.registerColor('COLOR1', function(r, g, b) {
    //     if (r > R_MIN - THRESHOLD && r < R_MAX + THRESHOLD && g > G_MIN - THRESHOLD && g < G_MAX + THRESHOLD && b > B_MIN - THRESHOLD && b < B_MAX + THRESHOLD) {
    //       return true;
    //     }
    //       return false;
    //   });
    //
    //   colorSet[0] = true;
    //   colors.setColors(['COLOR1']);
    //   console.log(`getColors(): ${colors.getColors()}`);
    //
    // } else if (!colorSet[1]){
    //   colors.constructor.registerColor('COLOR2', function(r, g, b) {
    //     if (r > R_MIN - THRESHOLD && r < R_MAX + THRESHOLD && g > G_MIN - THRESHOLD && g < G_MAX + THRESHOLD && b > B_MIN - THRESHOLD && b < B_MAX + THRESHOLD) {
    //       return true;
    //     }
    //       return false;
    //   });
    //
    //   colorSet[1] = true;
    //   colors.setColors(['COLOR1', 'COLOR2']);
    //   console.log(`getColors(): ${colors.getColors()}`);
    //
    // } else if (!colorSet[2]){
    //   colors.constructor.registerColor('COLOR3', function(r, g, b) {
    //     if (r > R_MIN - THRESHOLD && r < R_MAX + THRESHOLD && g > G_MIN - THRESHOLD && g < G_MAX + THRESHOLD && b > B_MIN - THRESHOLD && b < B_MAX + THRESHOLD) {
    //       return true;
    //     }
    //       return false;
    //   });
    //
    //   colorSet[2] = true;
    //   colors.setColors(['COLOR1', 'COLOR2', 'COLOR3']);
    //   console.log(`getColors(): ${colors.getColors()}`);
    //
    //
    // }

  function displayColor(R_MIN, R_MAX, G_MIN, G_MAX, B_MIN, B_MAX, i){
    // for (let i = 0; i < colorDisplay.length; i++){
      if (!colorProps[i].set){
          colorDisplay[i].style.background = `linear-gradient(to bottom right, rgba(${R_MIN}, ${G_MIN}, ${B_MIN}, 1), rgba(${R_MAX}, ${G_MAX}, ${B_MAX}, 1))`;
          // break;
      }
    // }
  }

    // if (!colorSet[0]){
    //   colorDisplay[0].style.background = `linear-gradient(to bottom right, rgba(${R_MIN}, ${G_MIN}, ${B_MIN}, 1), rgba(${R_MAX}, ${G_MAX}, ${B_MAX}, 1))`;
    //
    // } else if (!colorSet[1]){
    //   colorDisplay[1].style.background = `linear-gradient(to bottom right, rgba(${R_MIN}, ${G_MIN}, ${B_MIN}, 1), rgba(${R_MAX}, ${G_MAX}, ${B_MAX}, 1))`;
    //
    // } else if (!colorSet[2]){
    //   colorDisplay[2].style.background = `linear-gradient(to bottom right, rgba(${R_MIN}, ${G_MIN}, ${B_MIN}, 1), rgba(${R_MAX}, ${G_MAX}, ${B_MAX}, 1))`;
    // }

  function resetColorDisplay(){
    colorDisplay.forEach((elem) => elem.style.background = `linear-gradient(to bottom right, rgba(255,255,255,0), rgba(255,255,255,0))`);
    // colorDisplay[0].style.background = `linear-gradient(to bottom right, rgba(255,255,255,0), rgba(255,255,255,0))`;
    // colorDisplay[1].style.background = `linear-gradient(to bottom right, rgba(255,255,255,0), rgba(255,255,255,0))`;
    // colorDisplay[2].style.background = `linear-gradient(to bottom right, rgba(255,255,255,0), rgba(255,255,255,0))`;
  }

  function muteAll(){
    console.log('muteAll');
    for (let i = 0; i < sounds.length; i++){
      sounds[i].volume = 0;
    }
    console.log(sounds);
    // sounds.forEach((checkSound, i) => {
    //   if (checkSound.volume > 0) mute(checkSound);
    // });
  }

  function reset(){
    //re-initialize colorTracker instance
    if (trackerTask) trackerTask.stop();
    colors = new tracking.ColorTracker();
    colorStore = [];
    registerComplete = false;

    for (let i = 0; i < colorProps.length; i++){
      colorProps[i] = {'name': '', 'set': false, 'detected': false};
    }
    muteAll();
    btnNewColor.style.visibility = 'visible';
    resetColorDisplay();
    sounds.forEach((sound) => {
      sound.pause();
      sound.currentTime = 0;
      sound.setAttribute('loop', 'true');
      soundPlaying[`${sound.getAttribute('data-number')}`] = false;
    });
    // console.log(`reset() soundPlaying: ${soundPlaying}`);
    // for (let i = 0; i < sounds.length; i++){
    //   sounds[i].pause();
    //   sounds[i].currentTime = 0;
    //   sounds[i].removeAttribute('loop', 'true');
    //   soundPlaying[`${sounds[i].getAttribute('data-number')}`] = false;
    // }
    startMusic = false;
  }

  function replay(audio){
    if(!startMusic){
      console.log('music started playing');
      // audio.forEach((sound) => {
      //   sound.currentTime = 0;
      //   sound.setAttribute('loop', 'true');
      //   sound.play();
      //   soundPlaying[`${sound.getAttribute('data-number')}`] = true;
      // });
      for (let i = 0; i < audio.length; i++){
        audio[i].currentTime = 0;
        audio[i].setAttribute('loop', 'true');
        soundPlaying[`${audio[i].getAttribute('data-number')}`] = true;
        audio[i].play();
      }
    }
    startMusic = true;
  }

  function loadPreset(track){
    let preset = track.id;
    let numLayers;
    // console.log(`loadPreset: ${preset}`);
    for (let i = 0; i < soundPresets.length; i++){
      if (soundPresets[i].category == currentCategory){
        for (let x = 0; x < soundPresets[i].preset.length; x++){
          if(soundPresets[i].preset[x].id == preset){
            numLayers = soundPresets[i].preset[x].layers.length;

            soundPresets[i].preset[x].layers.forEach((layer, index) => {
              if (sounds[index]) {
                // console.log(`loadPresets sound ${sounds[index]} found;`);
                sounds[index].src = layer.path;
              } else if (!sounds[index]){
                createAudioElement(layer.path);
                createColorElement();
              }
              displayColorLabel(layer, index);
            });
            // soundList = document.querySelectorAll('audio');
            // sounds = [...soundList];
            loadSounds();
            break;
          }
        }
      }
    }

    // soundPresets.forEach((sound) => {
    //   if (sound.category == currentCategory){
    //     sound.preset.forEach((track) => {
    //       if (track.id == preset){
    //         // based on how many track layers, fill audio element src
    //         numLayers = track.layers.length;
    //         track.layers.forEach((layer, index) => {
    //           // console.log('loadPreset layers:')
    //           // console.log(layer);
    //           if (sounds[index]) {
    //             // console.log(`loadPresets sound ${sounds[index]} found;`);
    //             sounds[index].src = layer.path;
    //           } else if (!sounds[index]){
    //             createAudioElement(layer.path);
    //             createColorElement();
    //           }
    //           // sounds[i].src = track
    //         });
    //         // sounds[0].src = track.layers[0].path;
    //         // sounds[1].src = track.layers[1].path;
    //         // sounds[2].src = track.layers[2].path;
    //         //need to create colours for as many tracks are present in the presets
    //       }
    //     });
    //   }
    // });

    // console.log(`After soundPresets.forEach colorDisplay.length:`);
    // console.log(colorDisplay)
    // console.log(`After soundPresets.forEach sounds.length:`);
    // console.log(sounds);

    //remove surplus of audio tracks and color div elementss
    if (numLayers < sounds.length){
      trimDOM(numLayers);
    }
    // if (numLayers)
    // for (let i = 0; i < soundPresets.length; i++){
    //   if (preset == soundPresets[i].name){
    //     sounds[0].src = soundPresets[i].trackOne;
    //     sounds[1].src = soundPresets[i].trackTwo;
    //     sounds[2].src = soundPresets[i].trackThree;
    //     console.log(`${soundPresets[i].name} chosen`);
    //     togglePresets();
    //     break;
    //   }
    // }
  }

  function displayColorLabel(layer, index){
    colorDisplay[index].innerHTML = layer.type.toUpperCase();
  }

  function loadSounds(){
    for (let i = 0; i < sounds.length; i++){
      sounds[i].load();
      console.log(`loading ${sounds[i]}`)
    }
  }

  function trimDOM(max){
    // check existing in sounds
    // check existing in colorDisplay
    // console.log('trimDOM');
    // console.log(colorWrapper.querySelectorAll('.currentColors'));
    // console.log(audioWrapper.querySelectorAll('audio'));
    const currentColorList = colorWrapper.querySelectorAll('.currentColors');
    const currentAudioList = audioWrapper.querySelectorAll('audio');
    for (let i = 0; i < currentAudioList.length; i++){
      if (i >= max){
        colorWrapper.removeChild(currentColorList[i]);
        audioWrapper.removeChild(currentAudioList[i]);
      }
    }
    // console.log('afterTrim');
    // console.log(colorWrapper.querySelectorAll('.currentColors'));
    // console.log(audioWrapper.querySelectorAll('audio'));
    sounds.splice(max, sounds.length);
    colorDisplay.splice(max, colorDisplay.length);
    soundPlaying.splice(max, soundPlaying.length);
    colorProps.splice(max, colorProps.length);
    // detectColor.splice(max, detectColor.length);
    // console.log(`trimDOM`);
    // console.log(soundPlaying);

    // console.log(sounds);
    // console.log(colorDisplay);
  }

  function createAudioElement(path){
    // append new to audioWrapper
    // check existing in sounds
    const audioDOM = document.createElement('audio');
    audioDOM.setAttribute('src', path);
    audioDOM.setAttribute('id', `sound${sounds.length+1}`);
    audioDOM.setAttribute('data-number', `${sounds.length}`);

    audioWrapper.appendChild(audioDOM);
    sounds.push(audioDOM);
    soundPlaying.push(false);
    console.log(sounds);
    // console.log('createAudoElement');
    // console.log(soundPlaying);
    // console.log('createAudioElement');
    // console.log(sounds);
  }

  function createColorElement(){
    // append new to colorWrapper
    // check existing in colorDisplay
    const colorDOM = document.createElement('div');
    colorDOM.setAttribute('id', `currentColor${colorDisplay.length+1}`);
    colorDOM.setAttribute('class', 'currentColors');

    colorDisplay.push(colorDOM);
    colorWrapper.appendChild(colorDOM);
    colorProps.push({'name': '', 'set': false, 'detected': false});
    // detectColor.push(false);
    // console.log('createColorElement');
    // console.log(colorDisplay);

  }

  function mute(audio){
    audio.volume = 0;
  }

  let wrapper = document.querySelector('#presetTrackWrapper');
  function clearTrackPresets(){
    while (wrapper.firstChild) {
      wrapper.removeChild(wrapper.firstChild);
    }
  }

  function toggleGuide(){
    newColorGuide.style.left = `${video.offsetLeft + ((video.clientWidth/2)-(newColorGuide.clientWidth/2))}px`;

    newColorGuide.style.top = `${video.offsetTop + ((video.clientHeight/2)-(newColorGuide.clientHeight/2))}px`;

    newColorGuide.style.opacity = (newColorGuide.style.opacity == 0 ? '1' : '0');
  }

  function togglePresets(){
    if (presetsWrapper.style.opacity == 0){
      presetsWrapper.style.opacity = '1';
      presetCategoryWrapper.style.display = 'block';
    } else if (presetsWrapper.style.opacity == 1){
      presetsWrapper.style.opacity = '0';
      presetCategoryWrapper.style.display = 'none';
      clearTrackPresets();
    }
    presetTrackWrapper.style.display = 'none';
  }

  function toggleTrackPresets(){
    presetTrackWrapper.style.display = (presetTrackWrapper.style.display == 'none' ? 'block' : 'none');

    //Fill #presetTrackWrapper with the current track presets in specified category
    soundPresets.forEach(function(sound){
      if (sound.category == currentCategory){
        for(let i = 0; i < sound.preset.length; i++){
          let trackElement = divTrackWrapper.cloneNode(true);
          trackElement.firstChild.setAttribute('id', `${sound.preset[i].id}`);
          trackElement.firstChild.innerHTML = sound.preset[i].name;
          wrapper.appendChild(trackElement);
        }
      }
    });
  }

  function toggleCategory(){
    presetCategoryWrapper.style.display = (presetCategoryWrapper.style.display == 'block' ? 'none' : 'block');
    toggleTrackPresets();
  }

  function resetButtonBackgrounds(){
    allButtons.forEach(button => {
      button.style.background = 'rgba(241,241,241, 0.6)';
      button.style.color = 'rgba(100, 100, 100, 0.8)';
    });
  }

  function addActive(element){
    element.style.background = 'rgba(100,100,100, 0.1)';
  }

  function onClick(event){
    console.log(event);
    let target = event.target;

    if (target.id !== ''){ click.currentTime = 0; click.play()}
    if (target.id == 'btnReset') { reset() }
    if (target.id == 'btnNewColor') { clickNewColor() }
    if (target.id == 'btnGuides') { toggleGuide() }
    if (target.id == 'btnPresets') { togglePresets() }
    if (target.id.startsWith('category')){
      currentCategory = target.id;
      toggleCategory();
    }
    if (target.id.startsWith('preset-')){
      currentPreset = target.id;
      if (startMusic) reset();
      loadPreset(target);
      togglePresets();
    }
    if (target.id === 'presetsWrapper') { togglePresets() }
    if (target.id === 'start') {
      cover.style.opacity = 0;
      setTimeout(() => {
        cover.style.display = 'none';
      }, 500);
    }
  }

  function handleMouseDown(event){
    if (event.target.id.indexOf('btn') >= 0){ addActive(event.target) }
  }

  function handleMouseUp(event){
    resetButtonBackgrounds();
  }

  window.addEventListener('click', onClick);
  window.addEventListener('mousedown', handleMouseDown);
  window.addEventListener('mouseup', handleMouseUp);
  </script>
</body>
</html>
